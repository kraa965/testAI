<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8" />
	<title>Gnatone Mirror AI</title>

	<style>
      * { box-sizing: border-box; }

      body {
          font-family: Inter, Arial, sans-serif;
          background: #f6f7fb;
          text-align: center;
          padding: 40px;
      }

      h2 {
          font-size: 28px;
          margin-bottom: 5px;
          font-weight: 700;
      }

      #imageFile { display: none; }

      /* MAIN UPLOAD BOX */
      .main-box {
          width: 520px;
          margin: 30px auto;
          background: white;
          border-radius: 20px;
          padding: 16px;
          border: 2px dashed #aaa;
          box-shadow: 0 10px 40px rgba(0,0,0,0.12);
          cursor: pointer;
          transition: 0.2s;
      }

      /*.main-box:hover {
          border-color: #0077ff;
          transform: translateY(-2px);
      }*/

      /* IMAGE AREA */
      .compare-container {
          position: relative;
          width: 480px;
          height: 480px;
          border-radius: 16px;
          overflow: hidden;
          background: #000;
          margin: auto;
      }

      .compare-container img {
          position: absolute;
          inset: 0;
          width: 100%;
          height: 100%;
          object-fit: cover;
          display: none;
      }

      /* PLACEHOLDER */
      .placeholder {
          position: absolute;
          inset: 0;
          display: flex;
          justify-content: center;
          align-items: center;
          font-size: 18px;
          color: #666;
          background: rgba(255,255,255,0.95);
          text-align: center;
          padding: 20px;
      }

      /* SLIDER */
      #afterImg {
          clip-path: inset(0 0 0 50%); /* AI —Å–ø—Ä–∞–≤–∞ */
      }

      #slider {
          position: absolute;
          top: 0;
          left: 50%;
          width: 2px;
          height: 100%;
          background: rgba(255,255,255,0.9);
          backdrop-filter: blur(4px);
          box-shadow: 0 0 15px rgba(0,0,0,0.6);
          cursor: ew-resize;
          display: none;
      }

      #slider::before {
          content: "‚áÜ";
          position: absolute;
          top: 50%;
          left: -22px;
          width: 44px;
          height: 44px;
          background: rgba(0,119,255,0.95);
          border-radius: 50%;
          border: 3px solid white;
          transform: translateY(-50%);
          color: white;
          font-size: 18px;
          font-weight: bold;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 8px 20px rgba(0,0,0,0.4);
          transition: 0.2s;
      }

      #slider:hover::before {
          transform: translateY(-50%) scale(1.15);
      }

      /* Disable selection & dragging for slider images */
      .compare-container,
      .compare-container img {
          user-select: none;
          -webkit-user-select: none;
          -ms-user-select: none;
          -moz-user-select: none;

          -webkit-user-drag: none;
          user-drag: none;
          pointer-events: none;
      }

      .shade-panel {
          width: 520px;
          margin: 20px auto;
          display: none;
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
          gap: 10px;
      }

      .shade-item {
          background: white;
          border-radius: 10px;
          padding: 6px;
          box-shadow: 0 4px 10px rgba(0,0,0,0.12);
          text-align: center;
          font-size: 12px;
          cursor: pointer;
          border: 2px solid transparent;
      }

      .shade-item img {
          width: 100%;
          border-radius: 6px;
      }

      .shade-item input {
          margin-top: 4px;
      }

      .shade-item.selected {
          border-color: #0077ff;
      }


      /* –ù–æ slider –¥–æ–ª–∂–µ–Ω –ª–æ–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏—è */
      #slider {
          pointer-events: auto !important;
      }



      /* STATUS */
      #loading {
          margin-top: 12px;
          font-size: 16px;
          display: none;
      }

      #statusText {
          font-weight: bold;
          font-size: 17px;
          color: #0077ff;
          animation: blink 1.8s infinite;
      }

      @keyframes blink {
          0%,100% { opacity: 0.2; }
          50% { opacity: 1; }
      }

      /* TIMER */
      #timer {
          font-size: 20px;
          font-weight: bold;
          color: #0077ff;
      }

      /* DOWNLOAD */
      #downloadBtn {
          margin-top: 14px;
          padding: 10px 22px;
          border: none;
          border-radius: 8px;
          background: #00ff59;
          color: black;
          font-weight: bold;
          cursor: pointer;
          display: none;
      }

      #downloadBtn:hover {
          color: black;
          background: #018b2c;
      }

      #sendBtn {
          margin-top: 16px;
          padding: 14px 36px;
          border: none;
          border-radius: 999px;
          background: linear-gradient(135deg, #0077ff, #00c6ff);
          color: white;
          font-size: 16px;
          font-weight: 700;
          letter-spacing: 0.3px;
          cursor: pointer;
          box-shadow: 0 10px 30px rgba(0,119,255,0.35);
          transition: all 0.25s ease;
          position: relative;
          overflow: hidden;
      }

      #sendBtn:hover {
          transform: translateY(-2px) scale(1.02);
          box-shadow: 0 14px 40px rgba(0,119,255,0.5);
      }

      #sendBtn:active {
          transform: scale(0.98);
          box-shadow: 0 6px 20px rgba(0,119,255,0.4);
      }

      #sendBtn::before {
          content: "";
          position: absolute;
          inset: -2px;
          background: linear-gradient(45deg, #00c6ff, #0077ff, #00ffe7);
          opacity: 0;
          filter: blur(10px);
          transition: 0.3s;
      }

      #sendBtn:hover::before {
          opacity: 0.6;
      }

      #sendBtn.loading {
          pointer-events: none;
          background: linear-gradient(135deg, #555, #777);
      }

      #sendBtn.loading::after {
          content: "–õ–µ—á–∏–º –∑—É–±—ã...";
          position: absolute;
          inset: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 14px;
          font-weight: 600;
          background: rgba(0,0,0,0.45);
          backdrop-filter: blur(4px);
      }


	</style>
</head>

<body>

<h2>Gnatone Mirror AI</h2>

<input type="file" id="imageFile" accept="image/*">

<div class="main-box" id="uploadBox">
	<div class="compare-container" id="compareBox">
		<img id="beforeImg">
		<img id="afterImg">
		<div id="slider"></div>
		<div class="placeholder" id="placeholder">
			üì∏ –ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ
		</div>
	</div>
</div>

<div id="shadePanel" class="shade-panel"></div>

<div id="loading">
	<div id="timer">00:00</div>
</div>
<button id="sendBtn">–õ–µ—á–∏—Ç—å –∑—É–±—ã</button>

<button id="downloadBtn">‚¨á –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>

<script>
	const fileInput = document.getElementById("imageFile");
	const uploadBox = document.getElementById("uploadBox");
	const compareBox = document.getElementById("compareBox");
	const beforeImg = document.getElementById("beforeImg");
	const afterImg = document.getElementById("afterImg");
	const slider = document.getElementById("slider");
	const placeholder = document.getElementById("placeholder");
	const loading = document.getElementById("loading");
	const statusText = document.getElementById("statusText");
	const downloadBtn = document.getElementById("downloadBtn");
	const timerEl = document.getElementById("timer");
	const sendBtn = document.getElementById("sendBtn");

	const VITA_SHADES = [
		"Bleach",
		"A1","A2","A3","A3.5","A4",
		"B1","B2","B3","B4",
		"C1","C2","C3","C4",
		"D2","D3","D4"
	];

	let selectedShade = null;

	const shadePanel = document.getElementById("shadePanel");

	function buildShadePanel() {
		shadePanel.innerHTML = "";

		VITA_SHADES.forEach(shade => {
			const div = document.createElement("div");
			div.className = "shade-item";

			// –í–ê–ñ–ù–û: png
			div.innerHTML = `
			<img src="assets/${shade}.png" alt="${shade}">
<!--			<div>${shade}</div>-->
			<input type="radio" name="shade" value="${shade}">
		`;

			div.onclick = () => {
				document.querySelectorAll(".shade-item").forEach(e => e.classList.remove("selected"));
				div.classList.add("selected");
				div.querySelector("input").checked = true;
				selectedShade = shade;

				// ‚úÖ Live preview –∑—É–±–æ–≤
				// afterImg.src = `assets/${shade}.png`;
			};

			shadePanel.appendChild(div);
		});
	}


	let isDraggingSlider = false;
	let suppressUploadClick = false;


	beforeImg.draggable = false;
	afterImg.draggable = false;

	beforeImg.addEventListener("dragstart", e => e.preventDefault());
	afterImg.addEventListener("dragstart", e => e.preventDefault());


	let timerInterval, startTime, busy = false;

	// ===== TIME FORMAT mm:ss =====
	function formatTime(ms) {
		const t = Math.floor(ms / 1000);
		return String(Math.floor(t/60)).padStart(2,"0") + ":" + String(t%60).padStart(2,"0");
	}

	function startTimer() {
		startTime = performance.now();
		timerEl.textContent = "00:00";
		clearInterval(timerInterval);
		timerInterval = setInterval(() => {
			timerEl.textContent = formatTime(performance.now() - startTime);
		}, 200);
	}

	function stopTimer() {
		clearInterval(timerInterval);
		timerEl.textContent = "–í—Ä–µ–º—è: " + formatTime(performance.now() - startTime);
	}

	// CLICK UPLOAD
	uploadBox.addEventListener("click", e => {
		if (busy || isDraggingSlider || suppressUploadClick) return;
		fileInput.click();
	});

	// DRAG DROP
	uploadBox.ondragover = e => { e.preventDefault(); uploadBox.style.borderColor="#0077ff"; };
	uploadBox.ondragleave = () => uploadBox.style.borderColor="#aaa";
	uploadBox.ondrop = e => {
		e.preventDefault();
		uploadBox.style.borderColor="#aaa";
		fileInput.files = e.dataTransfer.files;
		fileInput.onchange();
	};

	// FILE HANDLER
	fileInput.onchange = async () => {
		const file = fileInput.files[0];
		if (!file) return;

		// show original
		beforeImg.src = URL.createObjectURL(file);
		beforeImg.style.display = "block";

		// hide AI layer
		afterImg.style.display = "none";
		slider.style.display = "none";

		// remove placeholder overlay fully
		placeholder.style.display = "none";
		placeholder.style.opacity = "0";
		placeholder.style.pointerEvents = "none";

		// palette
		shadePanel.style.display = "grid";
		buildShadePanel();
	};

	// SLIDER (mouse + touch)
	let dragging = false;

	function moveSlider(x) {
		const rect = compareBox.getBoundingClientRect();
		x = Math.max(0, Math.min(x - rect.left, rect.width));
		const p = (x / rect.width) * 100;
		slider.style.left = p + "%";
		afterImg.style.clipPath = `inset(0 0 0 ${p}%)`;
	}

	// mouse
	slider.addEventListener("mousedown", e => {
		dragging = true;
		isDraggingSlider = true;
		suppressUploadClick = true;
		e.stopPropagation();
		e.preventDefault();
	});

	window.addEventListener("mouseup", () => {
		dragging = false;
		setTimeout(() => {
			isDraggingSlider = false;
			suppressUploadClick = false;
		}, 100);
	});

	window.addEventListener("mousemove", e => {
		if (dragging) moveSlider(e.clientX);
	});

	// touch
	slider.addEventListener("touchstart", e => {
		dragging = true;
		isDraggingSlider = true;
		suppressUploadClick = true;
		e.stopPropagation();
		e.preventDefault();
	});

	window.addEventListener("touchend", () => {
		dragging = false;
		setTimeout(() => {
			isDraggingSlider = false;
			suppressUploadClick = false;
		}, 100);
	});

	window.addEventListener("touchmove", e => {
		if (dragging) moveSlider(e.touches[0].clientX);
	});

	document.getElementById("sendBtn").onclick = async () => {
		if (!selectedShade) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç—Ç–µ–Ω–æ–∫");
		const file = fileInput.files[0];
		if (!file) return alert("–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ");

		loading.style.display = "block";
		startTimer();

		const img = await createImageBitmap(file);
		const canvas = document.createElement("canvas");
		canvas.width = 1024;
		canvas.height = img.height * 1024 / img.width;
		canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);
		const blob = await new Promise(r => canvas.toBlob(r, "image/jpeg", 0.85));

		const formData = new FormData();
		formData.append("image", blob);
		formData.append("shade", selectedShade);

		sendBtn.classList.add("loading");

		const res = await fetch("https://geminin-image-ai.vercel.app/api/image", {
			method: "POST",
			body: formData
		});

		const data = await res.json();

		sendBtn.classList.remove("loading");

		if (data.imageBase64) {
			afterImg.src = data.imageBase64;
			afterImg.style.display = "block";

			// reset slider state
			slider.style.display = "block";
			slider.style.left = "50%";
			slider.style.pointerEvents = "auto";

			// IMPORTANT reset clip
			afterImg.style.clipPath = "inset(0 0 0 50%)";

			// show download
			downloadBtn.style.display = "inline-block";

			// download logic
			downloadBtn.onclick = () => {
				const a = document.createElement("a");
				a.href = data.imageBase64;
				a.download = "gnatone_result.jpg";
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
			};
		}

		stopTimer();
	};

</script>

</body>
</html>
